<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Callback</title>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }
    .success {
      padding: 24px;
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #30363d;
      border-top-color: #1f6feb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="success">
    <div class="spinner"></div>
    <h2>Signing in...</h2>
    <p>Please wait while we authenticate you.</p>
  </div>

  <script>
    const code = new URLSearchParams(window.location.search).get("code");

    if (!code) {
      document.body.innerHTML = `
        <div class="success">
          <h3>❌ Authorization failed</h3>
          <p>No authorization code received.</p>
          <button onclick="window.close()" style="margin-top: 16px; padding: 8px 16px; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
        </div>
      `;
    } else {
      // Use relative URL to avoid CORS issues
      fetch(`/exchange?code=${code}`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (data.access_token) {
            // Store token
            localStorage.setItem("token", data.access_token);
            
            // Try to send message to opener window (if opened from another tab)
            if (window.opener && !window.opener.closed) {
              try {
                // Send message to opener with token
                window.opener.postMessage({ 
                  type: 'GITHUB_AUTH_SUCCESS', 
                  token: data.access_token 
                }, window.location.origin);
                
                document.body.innerHTML = `
                  <div class="success">
                    <h3>✅ Authorization Successful!</h3>
                    <p>You have been authenticated with GitHub.</p>
                    <p style="font-size: 14px; color: #8b949e; margin-top: 12px;">This tab will close automatically...</p>
                  </div>
                `;
                
                // Close the tab after a short delay
                setTimeout(() => {
                  try {
                    window.close();
                  } catch (e) {
                    // If can't close, redirect to dashboard
                    window.location.href = "dashboard.html";
                  }
                }, 2000);
              } catch (e) {
                console.error("Error sending message:", e);
                // If postMessage fails, redirect in current tab
                document.body.innerHTML = `
                  <div class="success">
                    <h3>✅ Authorization Successful!</h3>
                    <p>Redirecting to dashboard...</p>
                  </div>
                `;
                setTimeout(() => {
                  window.location.href = "dashboard.html";
                }, 1000);
              }
            } else {
              // If opened directly (no opener), redirect in current tab
              document.body.innerHTML = `
                <div class="success">
                  <h3>✅ Authorization Successful!</h3>
                  <p>Redirecting to dashboard...</p>
                </div>
              `;
              setTimeout(() => {
                window.location.href = "dashboard.html";
              }, 1000);
            }
          } else {
            document.body.innerHTML = `
              <div class="success">
                <h3>❌ Login failed</h3>
                <p>${data.error || 'Failed to get access token'}</p>
                <button onclick="window.close()" style="margin-top: 16px; padding: 8px 16px; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
              </div>
            `;
            console.error(data);
          }
        })
        .catch(err => {
          console.error("Full error:", err);
          let errorMessage = err.message || "An unknown error occurred";
          
          // Provide more helpful error messages
          if (errorMessage.includes("Failed to fetch") || errorMessage.includes("NetworkError")) {
            errorMessage = "Unable to connect to the server. Please make sure the server is running on http://localhost:3000";
          } else if (errorMessage.includes("HTTP error")) {
            errorMessage = "Server error occurred. Please try again or contact support.";
          }
          
          document.body.innerHTML = `
            <div class="success">
              <h3>⚠️ Error exchanging code</h3>
              <p>${errorMessage}</p>
              <p style="font-size: 12px; color: #8b949e; margin-top: 8px;">If this problem persists, please try signing in again.</p>
              <button onclick="window.close()" style="margin-top: 16px; padding: 8px 16px; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
            </div>
          `;
        });
    }
  </script>
</body>
</html>
